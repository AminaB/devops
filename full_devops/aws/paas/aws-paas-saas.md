# refactoring with aws paas and CloudFront

## prerequisite
- aws-lift-shift-app-workload.md : lift and shift

# refactoring or re-architect with aws to improve business continuity and boost agility
objective : flexible infra, no upfront cost, Iaac, paas
- Beanstalk : 
  - Front : create EC2s, LB, ASG, S3, EBS
- back : RDS, Elastic cache instead of MEMCACHED, Active MQ instead of Rabbit MQ, Route 53 for dns, cloudfront for content delivery network
### scenario
- url  -> resolve by route 53 -> cloudfront (cache) -> beanstalk (app LB -> ASG -> ec2 )

## Workflow
- login to aws account
- create key pair for beanstalk instance login
### create SG for back end 
  - name : vprofile-backend-SG
  - add inbound rules : from vprofile-backend-SG itself
### create RDS
  - create subnet group : vprofile-rds-sub-group, select all az, select all subnets, create.
  - create parameter groups : vprofile-rds-para-group, mysql8
  - create database : 
    - Mysql
    - engine version : 8.0.32
    - templates : free tier
    - Availability and durability : single Db instance
    - db instance identifier : vprofile-rds-mysql
    - username : admin
    - autogenerated pwd
    - Burstable classes 
    - db.t2.micro
    - storage type : gp2
    - allocated : 20
    - ....
    - select the subnet group
    - pub accessibility : no
    - select SG : vprofile-backend-SG
    - AZ : no preference
    - granularity : 60 sec
    - init db name : accounts
    - param group : select vprofile-rds-para-group
    - log exports : check all
    - click create
    - view credentials details : and save user and pwd
### create Amazon Elastic cache
  - create subnet group : vprofile-memcached-sub-group, create.
  - create parameter groups : vprofile-memcached-para-group, memcached1.6
  - create memcached cluster : 
    - standard create
    - cluster name ans descr : vprofile-elasticache-svc
    - engine version : 1.6.17
    - ....
    - select param group
    - node type : cache.t2.micro
    - number of node : 1
    - choose the subnet
    - ...
    - SG : select vprofile-backend-SG
    - create
### create Amazon Active MQ
  - go to amazon mq
  - RabbitMq
  - single...
  - name : vprofile-rmq
  - t3.micro
  - username : rabbit
  - pwd :***
  - private access
  - select SG
  - next -> create

### init DB
  - lucnh ubuntu ec2
    - name : mysql-client
    - use key pair
    - create SG : mysql-client-sg
    - 22 from my IP
    - copy mysql-client-sg id, edit inbound rules of vprofile-backend-SG, add 3306 allowed from mysql-client-sg id
  - ssh to mysql-client
  - sudo apt update 
  - sudo apt install mysql-client -y
  - mysql -h "endpoint from rds" - u admin -pPwd accounts
  - show tables;
  - exit
  - git clone vprofile.git
  - mysql -h "endpoint from rds" - u admin -pPwd accounts <src/main/resources/db_backup.sql
  - mysql -h "endpoint from rds" - u admin -pPwd accounts
  - show tables
  - exit
  - terminate mysql-client
- copy endpoints of Active MQ and memcached


### create elastic beanstalk environment
  - platform service
  - create iam role
    - Ec2
    - policy : AWSElasticBeanstalkWebTier, AdministratorAccess-AWSElasticBeanstalk, AWSElasticBeanstalkRoleSNS, AWSElasticBeanstalkCustomPlatformforEC2Role
    - role name : vprofile-bean-role
    - create
  - create beanstalk application
    - name : vprofile-app
    - env name : vprofile-app-prod
    - domain : vprofileapp96 (unique)
    - platform : tomcat
    - platform branch : tomcat 8.5 corretto 11
    - custom configuration
    - create and use new service role
    - choose key pair
    - ec2-instance-profile : profile-bean-role
    - default vpc
    - activated public ip addr
    - deselect only last subnet
    - add tag : ...
    - IMDSv1 : check the deactivated button
    - ASG : load balanced selected -> min =2 max=8
    - t2.micro
    - Metric : networkOut
    - Application deployment
      - Rolling (read deployment policy : https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/using-features.rolling-version-deploy.html)
      - percentage 50
      - create
  - test 
[alt text](https://github.com/AminaB/devops/blob/master/full_devops/aws/paas/verifBeanStalkConfig.png)
  - open vprofile-app-prod
    - configuration -> edit "Instance traffic and scaling" -> go to "process" section -> action -> edit -> health check -> path : /login
    - sessions -> enabled check
    - add https in listener with port 443 (configuration -> edit "Instance traffic and scaling" -> go to "listener"). and choose the certificate 
    - health check will be (severe) because we don't have /login yet (we need to add the project)
### update SG of backend to allow traffic from elastic beanstalk EC2s SG
  - copy the SG id from ec2 created by beanstalk, to backend SG (allow all traffic from instance SG) or we can also allow traffic from EC2 only on 3 ports (mysql, elastic cache, rabbitMQ)

### build artifact with backend info
  - clone the project 
  - add endpoints (mysql, rabbitmq and memcached), username and pwd in application.properties
  - build : mvn install
- deploy artifact to beanstalk
  - go to aws console -> elastic beans stalk -> upload manually the war file in the beanstalk app
  - go to godaddy add record cname with name =vprofile ,value = vprofileapp96.us-east-1.elasticbeanstalk.com(beanstalk endpoint)
  ***
![alt text](https://github.com/AminaB/devops/blob/master/full_devops/aws/paas/domain.png)
  - test https://vprofile.barryit.xyz
### Stack created by beanstalk
- S3
***
![alt text](https://github.com/AminaB/devops/blob/master/full_devops/aws/paas/S3.png)
- EC2s
***
![alt text](https://github.com/AminaB/devops/blob/master/full_devops/aws/paas/EC2s.png)

- Load balancer
  ***
![alt text](https://github.com/AminaB/devops/blob/master/full_devops/aws/paas/LB.png)

- Target Group
  ***
![alt text](https://github.com/AminaB/devops/blob/master/full_devops/aws/paas/TG.png)

- Auto Scaling group
  ***
![alt text](https://github.com/AminaB/devops/blob/master/full_devops/aws/paas/ASG.png)
- Elastic Block Store
  ***
![alt text](https://github.com/AminaB/devops/blob/master/full_devops/aws/paas/EBS.png)
### create CDN with ssl cert
  - cloud front
  - cache website content into edge location
  - remove cname record to LB on godaddy
  - in aws console open cloudfront service, create -> select beanstalk elb -> https only or Match viewer ->
  - -> select the "legacy cache setting" -> header = All -> query string = All -> cookies = all
  - WAF = do not enable (not free)
  - alternate domain name= vprofile.barryit.xyz -> select certificate -> security policy = tlSv1
- update entry in goDaddy dsn zone
  - CNAME name = vprofile and value =dc5fzhfuyvwc9.cloudfront.net
- test the url :  https://vprofile.barryit.xyz
***
![alt text](https://github.com/AminaB/devops/blob/master/full_devops/aws/paas/CDNCloudFront.png)
- clean up